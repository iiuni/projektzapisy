{% extends "schedule/base.html" %}
{% load url from future %}

{% block schedule_reservation %} class="active"{% endblock %}

{% block bread %}
    <a href="/">Strona główna</a> &raquo;
    <a href="{% url 'events:classrooms' %}">Sale</a> &raquo;
{% endblock %}

{% block styles %}
    {{ block.super }}

    <link href="/site_media/css/jquery-ui-1.8.14.custom.css" rel="stylesheet" type="text/css"
          media="screen,projection"/>
    <link href="/site_media/js/timepicker/jquery.ui.timepicker.css" rel="stylesheet" type="text/css"
          media="screen,projection"/>
{% endblock %}

{% block js %}{{ block.super }}
    <style>
        .hidden {
            display: none !important;
        }

        .termtbl1 {
            width: 180px;
        }

        .termtbl4 {
            width: 300px;
        }

        .termtbl2 {
            width: 90px;
        }

        .termtbl3 {
            width: 261px;
        }

        #termstable td:nth-child(3), table td:nth-child(4), table th:nth-child(3), table th:nth-child(4) {
            text-align: left;
        }

        .removed {
            color: #d3d3d3;
        }

        .errorlist {
            list-style: none;
        }

        .errorlist > li {
            color: red;
        }

        *:invalid: {
            border: 2px solid red;
        }


    </style>
    <script type="text/javascript" src="/site_media/js/timepicker/jquery.ui.timepicker.js"></script>
    <script type="text/javascript" src="/site_media/js/timepicker/i18n/jquery.ui.timepicker-pl.js"></script>
    <script type="text/javascript" src="/site_media/js/jquery/jquery.smooth-scroll.js"></script>
    <script type="text/javascript">

    /* Modernizr 2.6.2 (Custom Build) | MIT & BSD
     * Build: http://modernizr.com/download/#-inputtypes-shiv-cssclasses-load
     */
    ;window.Modernizr=function(a,b,c){function v(a){j.cssText=a}function w(a,b){return v(prefixes.join(a+";")+(b||""))}function x(a,b){return typeof a===b}function y(a,b){return!!~(""+a).indexOf(b)}function z(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:x(f,"function")?f.bind(d||b):f}return!1}function A(){e.inputtypes=function(a){for(var d=0,e,f,h,i=a.length;d<i;d++)k.setAttribute("type",f=a[d]),e=k.type!=="text",e&&(k.value=l,k.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(f)&&k.style.WebkitAppearance!==c?(g.appendChild(k),h=b.defaultView,e=h.getComputedStyle&&h.getComputedStyle(k,null).WebkitAppearance!=="textfield"&&k.offsetHeight!==0,g.removeChild(k)):/^(search|tel)$/.test(f)||(/^(url|email)$/.test(f)?e=k.checkValidity&&k.checkValidity()===!1:e=k.value!=l)),o[a[d]]=!!e;return o}("search tel url email datetime date month week time datetime-local number range color".split(" "))}var d="2.6.2",e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k=b.createElement("input"),l=":)",m={}.toString,n={},o={},p={},q=[],r=q.slice,s,t={}.hasOwnProperty,u;!x(t,"undefined")&&!x(t.call,"undefined")?u=function(a,b){return t.call(a,b)}:u=function(a,b){return b in a&&x(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=r.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(r.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(r.call(arguments)))};return e});for(var B in n)u(n,B)&&(s=B.toLowerCase(),e[s]=n[B](),q.push((e[s]?"":"no-")+s));return e.input||A(),e.addTest=function(a,b){if(typeof a=="object")for(var d in a)u(a,d)&&e.addTest(d,a[d]);else{a=a.toLowerCase();if(e[a]!==c)return e;b=typeof b=="function"?b():b,typeof f!="undefined"&&f&&(g.className+=" "+(b?"":"no-")+a),e[a]=b}return e},v(""),i=k=null,function(a,b){function k(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function l(){var a=r.elements;return typeof a=="string"?a.split(" "):a}function m(a){var b=i[a[g]];return b||(b={},h++,a[g]=h,i[h]=b),b}function n(a,c,f){c||(c=b);if(j)return c.createElement(a);f||(f=m(c));var g;return f.cache[a]?g=f.cache[a].cloneNode():e.test(a)?g=(f.cache[a]=f.createElem(a)).cloneNode():g=f.createElem(a),g.canHaveChildren&&!d.test(a)?f.frag.appendChild(g):g}function o(a,c){a||(a=b);if(j)return a.createDocumentFragment();c=c||m(a);var d=c.frag.cloneNode(),e=0,f=l(),g=f.length;for(;e<g;e++)d.createElement(f[e]);return d}function p(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return r.shivMethods?n(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+l().join().replace(/\w+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(r,b.frag)}function q(a){a||(a=b);var c=m(a);return r.shivCSS&&!f&&!c.hasCSS&&(c.hasCSS=!!k(a,"article,aside,figcaption,figure,footer,header,hgroup,nav,section{display:block}mark{background:#FF0;color:#000}")),j||p(a,c),a}var c=a.html5||{},d=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,e=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,f,g="_html5shiv",h=0,i={},j;(function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",f="hidden"in a,j=a.childNodes.length==1||function(){b.createElement("a");var a=b.createDocumentFragment();return typeof a.cloneNode=="undefined"||typeof a.createDocumentFragment=="undefined"||typeof a.createElement=="undefined"}()}catch(c){f=!0,j=!0}})();var r={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:c.shivCSS!==!1,supportsUnknownElements:j,shivMethods:c.shivMethods!==!1,type:"default",shivDocument:q,createElement:n,createDocumentFragment:o};a.html5=r,q(b)}(this,b),e._version=d,g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+q.join(" "):""),e}(this,this.document),function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1,a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,f,g;for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i),i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))};


    /* Loader Class
     *
     *
     *
     */

    var CleanTermForm = function () {
        $('#hiddenroom').attr('value', '');
        $('#location').attr('value', '');
        $('input[name="selectplace"]').each(function () {
            $(this).attr('checked', false);
        });
        $('#inputplace').attr('value', '');
        $('#inputplacediv').hide();
        $('#selectroom').hide();
        $('#canvasplacediv').hide();
        $('#addterm').text('Dodaj termin');
        $('#location').parent().css('border-bottom', '1px solid #DDD');
        $('#location').attr('disabled', false);
    }


    function relMouseCoords(evt) {
        var rect = this.getBoundingClientRect();
        return {
            x:evt.clientX - rect.left,
            y:evt.clientY - rect.top
        };
    }
    HTMLCanvasElement.prototype.relMouseCoords = relMouseCoords;

    var chosenbutton = new Image();
    chosenbutton.src = '/site_media/images/choose.png';

    var Loader = function (container) {
        {#        this.container = container;#}
        {#        this.spinner = new Object();#}
        {#        this.spinner = new Spinner();#}
    };

    Loader.prototype.start = function () {

        {#        var that = this,#}
        {#                opacity = 1.0,#}
        {#                animate = function () {#}
        {#                    that.container.style.opacity = opacity;#}
        {#                    opacity -= 0.1;#}
        {#                    if (opacity > 0.2) {#}
        {#                        setTimeout(animate, 100);#}
        {#                    }#}
        {#                }#}
        {#                ;#}
        {##}
        {#        setTimeout(animate, 100);#}
        {#        this.spinner.spin(this.container);#}
    };

    Loader.prototype.stop = function () {
        {#        this.spinner.stop();#}
        {#        this.container.style.opacity = 1.0;#}
    };

    var AjaxWrapper = function () {
        this.makeURL = function (date) {
            var s = date.split('-');
            return '/classrooms/terms/' + s[0] + '/' + s[1] + '/' + s[2] + '/';
        };
        this.cache = {};
    };

    AjaxWrapper.prototype.getJson = function (date, callback) {

        if (this.cache.hasOwnProperty(date)) {
            callback.call(this.cache[date], this.cache[date]);
            return;
        }

        var url = this.makeURL(date),
                that = this;
        var r = new XMLHttpRequest();

        r.open("GET", url, true);
        r.onreadystatechange = function () {
            if (r.readyState != 4 || r.status != 200) return; //error
            that.cache[date] = JSON.parse(r.responseText);
            callback.call(that.cache[date], that.cache[date]);

        };
        r.send('');
    };

    function check(input) {
        if (input.value != document.getElementById('email_addr').value) {
            input.setCustomValidity('The two email addresses must match.');
        } else {
            // input is valid -- reset the error message
            input.setCustomValidity('');
        }
    }

    {#    function check(input) {#}
    {#      if (input.value != document.getElementById('email_addr').value) {#}
    {#        input;#}
    {#      } else {#}
    {#        // input is valid -- reset the error message#}
    {#        input.#}
    {#      }#}
    {#    }#}


    var ReservationView = function () {

        if (!Modernizr.inputtypes.date) {
            $( "#term" ).datepicker( );
            $( "#term" ).datepicker( "option", "dateFormat", "yy-mm-dd" );
        }
        $('#end').change(function () {
            var start = $('#begin').val() + ':00',
                    end = $(this).val() + ':00';
            if (end < start) {
                this.setCustomValidity('Koniec musi następować po początku');
            } else {
                this.setCustomValidity('');
            }
        })

        var container = document.getElementById('addTermForm');
        var canvas = document.getElementById('can');

        var load = new Loader(container);
        var Ajax = new AjaxWrapper();
        var rooms = new ClassroomsList();


        $('.timepicker').timepicker({hours:{
            starts:8, // First displayed hour
            ends:21                  // Last displayed hour
        }});


        var changeType = function () {
            var type = document.getElementById('id_type'),
                    subject = document.getElementById('form_course'),
                    visible = document.getElementById('form_visible'),
                    title = document.getElementById('form_title'),
                    message = document.getElementById('sendmessage_visible'),
                    onchange = function () {
                        switch (type.value) {
                            case '0':
                            case '1':
                                $(subject).show();
                                $(title).hide();
                                $(visible).hide();
                                $('#id_course').attr('required', true);
                                $('#id_title').attr('required', false);
                                break;

                            case '2':
                                $(subject).hide();
                                $(title).show();
                                $(visible).show();
                                $('#id_course').attr('required', false);
                                $('#id_title').attr('required', true);
                                break;
                        }
                    }
                    ;
            if (type) {
                type.addEventListener('change', onchange, true);
                onchange();
            }
        };

        var addterm = function () {
            var addbutton = document.getElementById('addterm'),
                    form = document.getElementById('addTermForm'),
                    term = document.getElementById('term'),
                    from = document.getElementById('begin'),
                    to = document.getElementById('end'),

                    onchangeTerm = function (event) {
                        event.preventDefault();


                    },
                    onchangeHour = function (event) {
                        event.preventDefault();
                    },
                    onclickCanvas = function (event) {
                        rooms.click(event, function (item) {
                            $('#hiddenroom').val(item.id);
                            $('#location').val('Sala ' + item.title);
                            $.smoothScroll({
                                scrollElement:null,
                                scrollTarget:'#location'
                            });
                        })
                    };


            canvas.addEventListener('click', onclickCanvas, true);
            from.addEventListener('change', onchangeHour, true);
            to.addEventListener('change', onchangeHour, true);


        };


        $('#addoutsidelocation').click(function (event) {
            $('#hiddenroom').val("");
            $('#location').val($('#inputplace').val());
            $.smoothScroll({
                scrollElement:null,
                scrollTarget:'#location'
            });
            event.preventDefault();
        });

        $('#term').change(function (event) {
            if ($(this).val() === '') {
                $('#location').attr('disabled', true);
                $('#location').parent().css('border-bottom', '1px solid #DDD');
                $('#selectroom').hide();

            } else {
                $('#location').attr('disabled', false);
                loadTerms($('#term').val());
            }
        });

        $('#location').click(function (event) {
            event.preventDefault();
            $('#selectroom').show();
            $(this).parent().css('border-bottom', '0');
        });

        $('#addtermform').submit(function (event) {

            if ($('#hiddenid').val()) {

                var counter = parseInt($('#hiddenid').val());
            } else {
                var counter = parseInt($('input[name="term_set-TOTAL_FORMS"]').val());
            }


            var td;
            var html = $('<tr></tr>');

            event.preventDefault();
            td = $('<td></td>').append('<strong>' + $('#term').val() + '</strong>')
                    .append($('<input type="hidden" name="term_set-' + counter + '-day"  value="' + $('#term').val() + '">'))

            $(html).append(td);

            td = $('<td></td>').append('<span>' + $('#begin').val() + '</span>').append($('<input type="hidden" name="term_set-' + counter + '-start"  value="' + $('#begin').val() + '">'));


            $(html).append(td);

            td = $('<td></td>').append('<span>' + $('#end').val() + '</span>').append($('<input type="hidden" name="term_set-' + counter + '-end"  value="' + $('#end').val() + '">'));


            $(html).append(td);

            td = $('<td></td>')
                    .append($('<span>' + $("#location").val() + '</span>'))
                    .append($('<input type="hidden" name="term_set-' + counter + '-place" maxlength="255" value="' + $("#location").val() + '">'))
                    .append($('<input type="hidden" name="term_set-' + counter + '-room" value="' + $("#hiddenroom").val() + '">'));

            if ($('#hiddenid').val() && $('#termstable tbody tr').eq(counter).find('input[name$="-id"]').length > 0) {
                td.append(
                        jQuery("<p>").append($('#termstable tbody tr').eq(counter).find('input[name$="-id"]').clone()).html());
            }

            $(html).append(td);
            $(html).append($('<td><div class="hidden"><input type="checkbox" name="term_set-' + counter + '-DELETE" id="id_term_set-' + counter + '-DELETE"></div><button style="display:none" class="btn success unremoveterm" formnovalidate>Cofnij usunięcie</button><button class="btn danger removeterm" formnovalidate>Usuń</button></td>'));
            $(html).append($('<td><button class="btn editterm">Edytuj</button></td>'));

            if ($('#hiddenid').val()) {
                $('#termstable tbody tr').eq(counter).after(html);
                $('#termstable tbody tr').eq(counter).remove();
            } else {
                $('input[name="term_set-TOTAL_FORMS"]').val(parseInt(counter) + 1);
                $('#termstable tbody').append(html);
            }
            $('#location').attr('disabled', true);
            CleanTermForm();


        });

        $('.removeterm').live('click', function (event) {
            event.preventDefault();
            var parent = $(this).parent();
            parent.find('.hidden').find('input').attr('checked', true);
            parent.find('.unremoveterm').show();
            parent.parent().find('.editterm').hide();
            parent.parent().addClass('removed');
            $(this).hide();

        })

        $('.unremoveterm').live('click', function (event) {
            event.preventDefault();
            var parent = $(this).parent();
            parent.find('.hidden').find('input').attr('checked', false);
            parent.find('.removeterm').show();
            parent.parent().find('.editterm').show();
            parent.parent().removeClass('removed');
            $(this).hide();

        });


        var loadTerms = function (value) {
            Ajax.getJson(value, function (data) {
                rooms.load(data);
                rooms.setLines($('#begin').val(), $('#end').val());
                rooms.draw();
            });
        };

        $('input[name="selectplace"]').change(function () {
            switch ($(this).val()) {
                case 'inside':
                    $('#rooms_filter').show();
                    $('#inputplacediv').hide();
                    $('#canvasplacediv').show();
                    loadTerms($('#term').val());
                    break;

                case 'outside':
                    $('#rooms_filter').hide();
                    $('#canvasplacediv').hide();
                    $('#inputplacediv').show();
                    break;
            }
        });

        $('.timepicker').change(function () {
            rooms.setLines($('#begin').val(), $('#end').val());
            rooms.draw();
        });


        $('#filteroccupated').change(function () {
            rooms.draw();

        });

        $('#ignore_all_conflicts').change(function () {
          var checkboxes =  $('.ignore_conflicts > input');
          for (var i=0; i<checkboxes.length; i++) {
            checkboxes[i].value = (+checkboxes[i].value+1)%2;
          }
        })

        $('#save_event').click(function (event) {

            if ($('#termstable tbody').find('tr:not(.removed)').length == 0) {
                if (window.confirm("Czy na pewno chcesz usunąć to wydarzenie?"))
                  $('#testmainform').click();                          
            } else {
                this.setCustomValidity('');
                $('#testmainform').click();
            }
        });

        $('#testroomlistform').submit(function (e) {
            e.preventDefault();
        })

        $('.editterm').live('click', function (event) {
            var parent = $(this).parent().parent();
            var room = parent.find('input[name$="-room"]').val();
            var number = parent.parent().children().index(parent);
            var test = ("" === room);
            event.preventDefault();
            parent.addClass('edited');
            $('#addterm').text('Zmień termin');
            $('#term').val(parent.find('input[name$="-day"]').val());
            $('#begin').val(parent.find('input[name$="-start"]').val());
            $('#end').val(parent.find('input[name$="-end"]').val());
            $('#location').val(parent.find('input[name$="-place"]').val());

            $('#hiddenroom').val(room);
            $('#hiddenid').val(number);

            $('#location').attr('disabled', false);


            $('input[name="selectplace"]').each(function () {
                if ($(this).val() == 'outside') {
                    $(this).attr('checked', test);
                } else {
                    $(this).attr('checked', !test);

                }
            });

            $('#location').click();
            if (test) {
                $('#inputplace').val($('#location').val());
            }

            $('input[name="selectplace"]:checked').each(function () {
                switch ($(this).val()) {
                    case 'inside':
                        $('#rooms_filter').show();
                        $('#inputplacediv').hide();
                        $('#canvasplacediv').show();
                        loadTerms($('#term').val());
                        break;

                    case 'outside':
                        $('#rooms_filter').hide();
                        $('#canvasplacediv').hide();
                        $('#inputplacediv').show();
                        break;
                }
            });


        });

        $('.readonly').keydown(function (event) {
            event.preventDefault();
        })

        changeType();
        addterm();


    };


    var Classroom = function (ctx, item) {
                var config = {
                            width:400,
                            height:30,
                            corner:10,
                            boxheight:65,
                            x1:120,
                            y1:30,
                            y1a:30,
                            calculate:function () {
                                /*
                                 a******b
                                 e        g
                                 *        *
                                 f        h
                                 c******d

                                 for example b-g is rounded corner
                                 a - (x1, y1)
                                 b - (x2, y1)
                                 c - (x2, y2)
                                 d - (x2, y2)
                                 e - (x1corner, y1corner)
                                 f - (x1corner, y2corner)
                                 g - (x2corner, y1corner)
                                 h - (x2corner, y2corner)

                                 */
                                this.x2 = this.x1 + this.width;
                                this.y2 = this.y1 + this.height;
                                this.x1corner = this.x1 - this.corner;
                                this.x2corner = this.x2 + this.corner;
                                this.y1corner = this.y1 + this.corner;
                                this.y2corner = this.y2 - this.corner;
                                this.strokeStyle = ctx.strokeStyle;
                                this.evenHours = ['08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'];
                                that = this;

                                var getPixel = function (hour) {
                                    /*
                                     Find pixel location for time (clock).
                                     Eg. 8:00 - it's begining of axe, 22:00 - end,
                                     15:00 - it's center.
                                     */
                                    var cellSize = that.width / (that.evenHours.length - 1);
                                    var time = hour.split(":"),
                                            hours = (parseInt(time[0]) - 8) * cellSize / 2,
                                            minutes = Math.floor(( parseInt(time[1]) / 60 ) * cellSize) / 2;
                                    return hours + minutes;
                                };
                                this.terms = [];
                                for (var key in item.terms) {
                                    if (item.terms.hasOwnProperty(key)) {
                                        var event = item.terms[key];


                                        begin = getPixel(event.begin) + this.x1;
                                        end = getPixel(event.end) + this.x1;
                                        this.terms.push({'begin':begin, 'end':end});
                                    }
                                }

                                return this;
                            },
                            init:function () {
                                this.calculate();
                                delete this.init;
                                return this;
                            }
                        }.init(),

                        cellSize = config.width / (config.evenHours.length - 1),

                        drawButton = function () {

                            if (is_free()) {
                                ctx.drawImage(chosenbutton, config.x1 - 100, config.y1 + 1);
                            }
                        },

                        drawTitle = function () {
                            ctx.beginPath();
                            var save = ctx.font;
                            ctx.strokeStyle = config.strokeStyle;
                            ctx.font = '20px Calibri';
                            ctx.fillText(item.title + ' pojemność: ' + item.capacity + ', ' + item.type, config.x2corner + 10, config.y1 + 3 * config.height / 4);
                            ctx.stroke();
                            ctx.font = save;

                        },

                        drawBorder = function () {
                            /*
                             Draw borders
                             */
                            var c = config,
                                    save = ctx.strokeStyle;
                            ctx.beginPath();
                            ctx.moveTo(c.x1, c.y1);
                            ctx.lineTo(c.x2, c.y1);
                            ctx.quadraticCurveTo(c.x2corner, c.y1, c.x2corner, c.y1corner);
                            ctx.lineTo(c.x2corner, c.y2corner);
                            ctx.quadraticCurveTo(c.x2corner, c.y2, c.x2, c.y2);
                            ctx.lineTo(c.x1, c.y2);
                            ctx.quadraticCurveTo(c.x1corner, c.y2, c.x1corner, c.y2corner);
                            ctx.lineTo(c.x1corner, c.y1corner);
                            ctx.quadraticCurveTo(c.x1corner, c.y1, c.x1, c.y1);
                            ctx.stroke();

                            ctx.strokeStyle = save;
                        },

                        drawHours = function () {
                            var saveStroke = ctx.strokeStyle,
                                    saveAlign = ctx.textAlign,
                                    saveFont = ctx.font;
                            ctx.beginPath();
                            ctx.strokeStyle = "#787878";
                            ctx.textAlign = "left";
                            ctx.font = '12px Calibri';

                            for (var i = 0; i < config.evenHours.length; ++i) {
                                var x = config.x1 + i * cellSize;
                                ctx.moveTo(x, config.y1);
                                ctx.lineTo(x, config.y2);
                                ctx.fillText(config.evenHours[i], x - 14, config.y2 + 12);

                            }
                            ctx.stroke();
                            ctx.strokeStyle = saveStroke;
                            ctx.textAlign = saveAlign;
                            ctx.font = saveFont;
                        },


                        drawEvents = function () {
                            var saveStyle = ctx.fillStyle;
                            for (var key in config.terms) {
                                if (config.terms.hasOwnProperty(key)) {
                                    var event = config.terms[key];
                                    ctx.beginPath();
                                    ctx.fillStyle = "#b0c2f7";
                                    ctx.globalAlpha = 0.5; // Half opacity
                                    ctx.fillRect(event.begin, config.y1, event.end - event.begin, config.height);
                                    ctx.stroke();
                                    ctx.globalAlpha = 1;
                                }
                            }
                            ctx.fillStyle = saveStyle;
                        },

                        draw = function (index) {

                            config.y1 = config.y1a + index * config.boxheight;
                            config.calculate();
                            drawButton();
                            drawTitle();
                            drawBorder();
                            drawHours();
                            drawEvents();
                        },

                        getPixel = function (hour) {
                            /*
                             Find pixel location for time (clock).
                             Eg. 8:00 - it's begining of axe, 22:00 - end,
                             15:00 - it's center.
                             */

                            var time = hour.split(":"),
                                    hours = (parseInt(time[0]) - 8) * cellSize / 2,
                                    minutes = Math.floor(( parseInt(time[1]) / 60 ) * cellSize) / 2;
                            return hours + minutes;
                        },

                        click = function (event, cordinates, callback) {
                            if (!is_free()) return;
                            if ((cordinates.x >= config.x1 - 100) && (cordinates.x < config.x1 - 20)
                                    && (cordinates.y >= config.y1 + 1) && ( cordinates.y < config.y1 + 32)) {
                                callback.call(item, item);
                            }
                        },
                        lpixel, rpixel,
                        setLimit = function (left, right) {
                            lpixel = left;
                            rpixel = right;
                        },

                        is_free = function (force) {
                            {% if perms.schedule.manage_events %}
                              return true
                            {% endif %}
                            if (!rpixel || !lpixel) {
                                return false;
                            }
                            for (var key in config.terms) {
                                if (config.terms.hasOwnProperty(key)) {
                                    var pitem = config.terms[key];
                                    if (!(lpixel >= pitem.end || rpixel <= pitem.begin ))
                                    {
                                        return false;
                                    }
                                }
                            }
                            return true;
                        }
                        ;

                return {
                    draw:draw,
                    getPixel:function (item) {
                        return getPixel(item) + config.x1;
                    },
                    shouldBeShow:function (l, r) {
                        setLimit(getPixel(l) + config.x1, getPixel(r) + config.x1);
                        return is_free(true);
                    },
                    setLimit:setLimit,
                    click:click
                }
            },
            ClassroomsList = function () {

                var that = this,
                        init = function () {
                            that.canvas = document.getElementById("can");
                            that.ctx = document.getElementById("can").getContext("2d");
                        },

                        click = function (event, callback) {
                            var cords = that.canvas.relMouseCoords(event);
                            var nr = Math.floor(cords.y / 65);
                            classrooms[ toDraw[nr] ].click(event, cords, callback);
                        },

                        classrooms = [],
                        clearClassrooms = function () {
                            classrooms = [];
                        },
                        createClassroom = function (data) {
                            for (var classroom in data) {

                                if (data.hasOwnProperty(classroom)) {
                                    classrooms.push(new Classroom(that.ctx, data[classroom]));
                                }
                            }
                        },

                        lineFrom, lineTo,
                        setLines = function (from, to) {
                            lineFrom = from;
                            lineTo = to;
                        },

                        redraw = function () {

                        },
                        toDraw,
                        draw = function () {
                            var index = 0
                                    ;

                            toDraw = [];

                            for (var classroom in classrooms) {
                                if (classrooms.hasOwnProperty(classroom) && (shouldBeShow(classrooms[classroom]) || $('#filteroccupated').attr('checked') )) {
                                    toDraw[index] = classroom;
                                    index++;
                                }
                                that.canvas.height = 65 * (index + 1);
                            }
                            index = 0;
                            var lPixel, rPixel;
                            for (var c in toDraw) {
                                if (toDraw.hasOwnProperty(c)) {
                                    if (index === 0) {
                                        if (lineFrom) {
                                            lPixel = classrooms[toDraw[c]].getPixel(lineFrom);

                                        }
                                        if (lineTo) {
                                            rPixel = classrooms[toDraw[c]].getPixel(lineTo);
                                        }
                                    }
                                    classrooms[toDraw[c]].setLimit(lPixel, rPixel);
                                    classrooms[toDraw[c]].draw(index++);
                                }
                            }

                            if (lPixel) {
                                that.ctx.strokeStyle = "red";
                                that.ctx.beginPath();
                                that.ctx.moveTo(lPixel, 0);
                                that.ctx.lineTo(lPixel, that.canvas.height);
                                that.ctx.stroke();
                            }

                            if (rPixel) {
                                that.ctx.strokeStyle = "red";
                                that.ctx.beginPath();
                                that.ctx.moveTo(rPixel, 0);
                                that.ctx.lineTo(rPixel, that.canvas.height);
                                that.ctx.stroke();
                            }
                        },

                        shouldBeShow = function (classroom) {
                            var r = classroom.shouldBeShow(lineFrom, lineTo);
                            return r;
                        },
                        load = function (data) {
                            clearClassrooms();
                            createClassroom(data);
                        }
                        ;

                init();

                return {
                    'draw':draw,
                    'load':load,
                    'setLines':setLines,
                    'redraw':redraw,
                    'click':click
                };

            },


            cleanAddTermForm = function () {
            },


            init = function () {
                addterm();
            };

    window.onload = ReservationView;
    </script>
{% endblock %}

{% block content-width %}16{% endblock %}

{% block content %}
    <div class="row">
        <div class="span16">
            <h2>{% if is_edit %}Zmień rezerwacje{% else %}Nowa rezerwacja{% endif %}</h2>
        </div>
    </div>

    <form method="POST" id="mainform">
        {% csrf_token %}
        {% for hidden in form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        {{ form.non_field_errors }}
        <fieldset>

            {% if user.employee %}

                <div class="clearfix row">
                    <div class="span10">
                            <label for="id_type">Rodzaj</label>
                            <div class="input clearfix">
                                {{ form.type }}

                            </div>
                            </div>

                    <div class="span6" style="font-size:12px">
                        <span><strong>Egzaminy</strong> i <strong>kolokwia</strong>
                                                        - prowadzący moze zarezerwować salę, rezerwacja nie wymaga potwierdzenia</span>
                        <br/>
                        <br/>
                        <span><strong>Wydarzenia</strong> - każdy zalogowany może zgłosić chęć rezerwacji; rezerwacja zostaje potwierdzona lub odrzucona przez administratora sal.</span>
                    </div>
                          </div>

                <div id="form_course" class="row clearfix" style='display:none;'>
                    <div class="span10">
                    <label for="id_course">Przedmiot</label>
                    <div class="input">
                        {{ form.course }}
                    </div>
                  </div>
                  </div>



            {% endif %}

            <div id="form_title" class="row clearfix">
                <div class="span10">
                <label for="id_title">Tytuł</label>
                        <div class="input">
                            {{ form.title }}
                        </div>
                      </div>
                <div class="span6">

                    <span style="font-size:12px">Tytuł pod jakim widoczne będzie wydarzenie</span>
                </div>
                      </div>


            <div id="form_visible" class="row clearfix">
                <label id="optionsCheckboxes">Opcje</label>
                <div class="input">
                    <ul class="inputs-list">
                        <li>
                            <label>
                              {{ form.visible }}
                                <span>Wydarzenie widoczne dla wszystkich użytkowników systemu</span>
                            </label>
                        </li>

                  </ul>
                          <span style="font-size:12px;">
                            <strong>Uwagi:</strong> Wydarzenia niepubliczne widoczne są jedynie dla autorów i osób z uprawnieniami moderatora.
                          </span>
                        </div>
          </div>

            <div class="clearfix row">
                <div class="span10">
                        <label for="id_description">Opis</label>

                        <div class="input">
                            <div style="margin-right:10px">{{ form.description }}</div>
                            {{ form.description.errors }}&nbsp;
                        </div>
                      </div>
                <div class="span6">
                    <span style="font-size:12px">
                        Opis wydarzenia widoczny jest dla wszystkich, jeśli wydarzenie jest publiczne; widoczny tylko dla rezerwującego i administratora sal, gdy wydarzenie jest prywatne.
                    </span>
                </div>
            </div>

        </fieldset>

        <h3>Terminy</h3>
        {{ formset.management_form }}
        <table id="termstable" class="span16">
            <thead>
            <tr>
                <th class="termtbl1">Dzień</th>
                <th class="termtbl2">Od</th>
                <th class="termtbl2">Do</th>
                <th class="termtbl4">Lokalizacja</th>
                <th class="termtbl3" colspan="2">Akcje</th>
            </tr>
            </thead>
            <tbody>
            {% for form in formset %}
                <tr>
                    <td class="termtbl1"><strong>{{ form.instance.day|date:"Y-m-d" }}</strong>{{ form.day }}</td>
                    <td class="termtbl2"><span>{{ form.instance.start|time }}</span>{{ form.start }}</td>
                    <td class="termtbl2"><span>{{ form.instance.end|time }}</span>{{ form.end }}{{ form.id }}</td>
                    <td class="termtbl4"><span>{% if form.instance.room %}Sala
                        {{ form.instance.room.number }}{% else %}
                        {{ form.instance.place }}{% endif %}{{ form.room }}{{ form.place }}</span>
                        <span>{% if form.non_field_errors %}{{ form.non_field_errors }}{% endif %}</span>
                    </td>

                    <td>
                        <div class="hidden">{{ form.DELETE }}</div>
                        <div class="hidden ignore_conflicts">{{ form.ignore_conflicts }}</div>
                        <button style="display:none" class="btn success unremoveterm" formnovalidate>Cofnij
                            usunięcie
                        </button>
                        <button class="btn danger removeterm" formnovalidate>Usuń</button>
                    </td>
                    <td>
                        <button class="btn editterm" formnovalidate>Edytuj</button>
                    </td>
                </tr>
            {% endfor %}

            </tbody>
        </table>
        <input type="submit" style="display:none" name="sendthisform" value="test" id="testmainform">
    </form>
    <form id="addtermform" class="span16">
        <table>
            <tbody>
            <tr>
                <td class="termtbl1" style="border-bottom: 0">
                    <input id="term" type="date" class="term small" placeholder="{% now "Y-m-d" %}"
                           min="{% now "Y-m-d" %}" required>
                </td>
                <td class="termtbl2" style="border-bottom: 0">
                    <input id="begin" type="time" class="begin mini timepicker readonly" placeholder="np. 8:00" required
                           pattern="^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$">

                </td>
                <td class="termtbl2" style="border-bottom: 0">
                    <input id="end" type="time" class="end mini timepicker readonly" placeholder="np. 10:00" required
                           pattern="^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$">
                </td>
                <td class="termtbl1" style="border-bottom: 0">
                    <input type="hidden" id="hiddenroom" value="">
                    <input type="hidden" id="hiddenid" value="">
                    <input type="hidden" id="hiddeneventid" value="">
                    <input class="xlarge readonly" id="location" autocomplete="off" name="location"
                           placeholder="Miejsce" disabled="true"
                           type="text" required>

                </td>
                <td colspan="2" class="termtbl3" style="border-bottom: 0">
                    <button id="addterm" class="btn success">Dodaj termin</button>
                </td>
            </tr>
            <tr>
                <td class="termtbl1">
                    <small style="font-size: 12px">Wybierz termin, by zobaczyć sale wolne w tym czasie</small>
                </td>
                <td class="termtbl2">
                </td>
                <td class="termtbl2">
                </td>
                <td class="termtbl1">
                    <small style="font-size: 12px">Naciśnij, aby wybrać</small>
                </td>
                <td colspan="2" class="termtbl3">
                </td>
            </tr>
            </tbody>
        </table>
    </form>

    <form>
        <div id="selectroom" class="row" style="display:none;">
            <div class="span8">
                <div class="input">
                    <ul class="inputs-list">
                        <li>
                            <label>
                                <input type="radio" name="selectplace" value="outside">
                                <span>Miejsce zewnętrzne</span>
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="selectplace" value="inside">
                                <span>Sala Instytutu</span>
                            </label>
                        </li>

                    </ul>
                </div>
            </div>
            <fieldset id="rooms_filter" class="span7" style="display: none;">
                <legend>Filtruj sale</legend>
                <div class="input">
                    <ul class="inputs-list">
                        <li>
                            <label>
                                <input id="filteroccupated" type="checkbox" name="selectsssplace" value="outside"
                                       checked>
                                <span>Pokaż zajęte</span>
                            </label>
                        </li>
                        {#                                    <li>#}
                        {#                                        <label>#}
                        {#                                            <input type="checkbox" name="selesssctplace" value="inside">#}
                        {#                                            <span>Minimalna liczba miejsc</span>#}
                        {#                                        </label>#}
                        {#                                    </li>#}

                    </ul>
                </div>
            </fieldset>
        </div>


        <div id="inputplacediv" class="row" style="display: none;">
            <div class="row">
                <div class="span1">
                    <label for="inputplace">Miejsce</label>
                </div>
                <div class="span11">
                    <div class="input">
                        <div class="inline-inputs">
                            <input type="text" id="inputplace" class="span6"
                                   placeholder="np. Instytu Matematyczny, Sala HS">
                            <button class="btn success" id="addoutsidelocation">Dodaj</button>
                        </div>
                    </div>
                </div>
                <div class="span4 help-block">Musisz samemu zatroszczyć się o rezerwację!</div>
            </div>
        </div>
        <div id="canvasplacediv" class="row" style="display: none;">
            <canvas id="can" width="900">
                Niestety Twoja przeglądarka nie wspiera HTML5.
            </canvas>
        </div>
    </form>
    <div class="row">
        <form id="testroomlistform">
          {% if errors and perms.schedule.manage_events %}
            <div class="span16 left">
              <input type="checkbox" id="ignore_all_conflicts"> Zignoruj konflikty</input>
            </div>
            {% endif %}
            <div class="span16 right" style="text-align:right">
                <input type="submit" id="save_event" class="btn" name="zapisz" value="Zapisz">
            </div>
        </form>
    </div>


{% endblock %}
