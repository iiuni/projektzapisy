{% extends "base.html" %}
{% load render_bundle from webpack_loader %}

{% load crispy_forms_tags %}

{% block main-subtitle %}System prac dyplomowych{% endblock %}

{% block theses_active %} class="active"{% endblock %}

{% block all-content %}
<div id="thesis-root">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="d-inline-block">
        {% if new_thesis %}
            Dodawanie nowej pracy dyplomowej
        </h1>
        {% else %}
            Edycja pracy dyplomowej
        </h1>
        <form action="{% url 'theses:delete_thesis' id %}" method="POST" class="post-form">
            {% csrf_token %}
            <div class="text-end">
            <input class="btn btn-default btn-danger confirm-delete float-end align-bottom ms-3" name="delete" type="submit" value="Usuń pracę"/>
            <script>
                $(document).on('click', '.confirm-delete', function(){
                    return confirm('Czy na pewno chcesz usunąć tę pracę dyplomową?');
                })
            </script>
            </div>
        </form>
        {% endif %}
    </div>
    {% if confirm_changes %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center mt-2">
        <div class="d-inline-block">
            Temat został już zaakceptowany przez komisję. Wprowadzenie zmian innych niż dotyczące
            daty rezerwacji i przypisanych studentów spowoduje przesłanie go z powrotem do decyzji komisji.
        </div>
        <button class="btn btn-primary float-end edit-term-form ms-3" id="resetbtn" style="display: inline-block; white-space: normal; word-wrap: break-word;"> 
            Cofnij zmiany wymagające zgody komisji 
        </button>
    </div>
    {% endif %}

    <form method="POST" id="confirm-submit" class="post-form">
        <input type="hidden" id="id_selected_students" name="selected_students" value="">
        {% csrf_token %}
        {% crispy thesis_form %}
    </form>
    {% if confirm_changes %}
        {{ old_instance|json_script:"old_instance" }}
        {% render_bundle 'theses-theses-change' %} 
    {% endif %}
</div>

<script>
    $(document).ready(function() {
        let previousInput;
        let selectedStudentIds = [];

        function debounce(func, delay) {
            let timer;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timer);
                timer = setTimeout(function() {
                    func.apply(context, args);
                }, delay);
            };
        }

        function handleInput() {
            const inputValue = $("#id_user_input").val().trim();

            if (inputValue === previousInput || inputValue === '') {
                return;
            }
            previousInput = inputValue;

            $.ajax({
                url: '{% url "theses:get_data" %}',
                type: 'GET',
                data: {
                    'input_value': inputValue,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (data) {
                    $('#id_all_students').html(data.filtered_students);
                },
                error: function(xhr, status, error) {
                    console.error("Something went wrong :(");
                }
            });
        }

        function updateSelectedStudents() {
            const all_students = $('#id_all_students');
            const picked_students = $('#id_students');

            picked_students.find('option:selected').each(function() {
                all_students.append($(this).clone().prop('selected', false));
                const student_id = $(this).val();
                const index = selectedStudentIds.indexOf(student_id);
                selectedStudentIds.splice(index, 1);
                $(this).remove();
            });

            all_students.find('option:selected').each(function() {
                picked_students.append($(this).clone().prop('selected', false));
                selectedStudentIds.push($(this).val());
                $(this).remove();
            });
            $('#id_selected_students').val(selectedStudentIds.join(','));
            console.log('Selected Student IDs:', selectedStudentIds);
            console.log('Hidden input value:', $('#id_selected_students').val());
        }

        const debouncedInputHandler = debounce(handleInput, 200);
        $("#id_user_input").on("input", debouncedInputHandler);
        $('#id_all_students, #id_students').on('change', updateSelectedStudents);
    });
</script>

{% endblock %}
